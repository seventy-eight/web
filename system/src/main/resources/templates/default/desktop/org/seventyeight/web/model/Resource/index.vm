#foreach( $action in $item.getLayoutableHavingTemplate( $request.getTheme(), $request.getPlatform(), "preResource.vm" ) )
    #render( $action "preResource" false "" $item true )
#end

#menu($item.getMenu())

<table style="width:100%;height: 100%;border-collapse: collapse; max-width: inherit">

    <tbody style="max-width: inherit">

    #foreach( $action in $item.getLayoutableHavingTemplate( $request.getTheme(), $request.getPlatform(), "top.vm" ) )
        <tr>
            <td colspan="2" class="nothing" style=";padding: 0px">
                #render( $action "top" false "" $item true )
            </td>
        </tr>
    #end

    <tr>
        <td style="width:auto; text-align: left" class="headerContrast" colspan="2">
            $item.getDisplayName()

            #if($item.getAuthorization($request.getUser()).canModerate())
               <div style="float: right" class="floatingButton"><a href="configure">Edit</a></div>
            #end
        </td>
    </tr>

    <tr style="max-width: inherit;">
        <td style="width:auto;height: 100%;max-width: inherit;padding: 0px; margin: 0px">
            #render($item "view")

        </td>
        <td style="text-align: center; vertical-align: top">
            #foreach($action in $item.getActions())
                <div class="button">$action.getDisplayName()</div><br />
            #end
        </td>
    </tr>

    <!-- Comments -->
    <tr>
        <td colspan="2" style="width: 100%; text-align: center">

            #comments($item)

        </td>
    </tr>

    <tr>
        <td colspan="2" style="width: 100%; text-align: center;">

            <form method="post" id="conversationForm" style="min-width: inherit;">
                <input type="text" name="title" style="width: 100%">
                <input type="hidden" name="parent" value="$item.getIdentifier()">
                <textarea style="width: 100%" name="comment"></textarea>
                <button id="conversationSubmit" class="button">Send</button>
            </form>

            <script type="text/javascript">
				$(document).on("click", '.replyable', function(event) { 
				    //alert($(this).parent().parent().attr('id'));
				    var p = $(this).parent().parent().attr('id');
				    var pp = '#' + p + ' > .reply';
				    //alert($('#' + p + ' < .reply'));
				    //alert($(pp));
				    
				    $(pp).toggle();
					event.preventDefault();
				    return false;
				});
				
				// Submit a new conversation
                $( "#conversationSubmit" ).click(function(event) {
                    event.preventDefault();
                    var form = $('#conversationForm');
                    //alert("adawd"+form.attr('id'));
                    Utils.addJsonElement( form[0] );
                    $.ajax({
                        type: "POST",
                        url: "addConversation",
                        data: form.serialize(),
                        //success: function(data, textStatus, jqxhr){$(this).parent()[0].reset();addPost(data)},
                        success: function(data, textStatus, jqxhr){addConversation(data)},
                        error: function(ajax, text, error) {alert(error)}
                    });
                });
                
                $(document).on("click", '.commentSubmit', function(event) {
                	alert("HEY");
                    event.preventDefault();
                    //Utils.addJsonElement( document.getElementById('commentForm') );
                    var form = $(this).parent();
                    //alert("adawd"+form.attr('id'));
                    Utils.addJsonElement( form[0] );
                    $.ajax({
                        type: "POST",
                        url: "addComment",
                        data: form.serialize(),
                        //success: function(data, textStatus, jqxhr){$(this).parent()[0].reset();addPost(data)},
                        success: function(data, textStatus, jqxhr){addPost(data)},
                        error: function(ajax, text, error) {alert(error)}
                    });
                });

                function addPost(d) {
                	//alert("--->" + d);
                    var json = eval("(" + d + ")");
                    //$("#commentsContainer").append(json.view + "<br>").children(':last').hide().fadeIn(2000);
                    //$(json.view + "<br>").appendTo("#commentsContainer").hide().fadeIn(2000);
                    $(json.view + "<br>").appendTo("#" + json.parent + "-container").hide().fadeIn(2000);
                }
            </script>

        </td>
    </tr>


    <tr>
        <td style="width:100%;height: 100%" colspan="3">
            <div style="width: 100%;min-height: 400px" align="center">

                #foreach( $action in $item.getActions() )
                    #render( $action "bottom" )
                #end

                #foreach( $action in $item.getLayoutableHavingTemplate( $request.getTheme(), $request.getPlayform(), "bottom.vm" ) )
                    #renderStatic( $action.getClazz() "bottom" )
                #end

                <!--
                #foreach( $view in $item.getContributingViews( "bottom.vm", $theme ) )
                    #render( $view "bottom" )
                #end
                -->
            </div>
        </td>
    </tr>

    <tr>
        <td style="width:100%;height: 100%;font-size: 9px" class="headerContrast" align="left" colspan="2">
            Created about $dateUtils.getDateString($item.getCreated()) ago
            #if($item.getRevision() > 1)
                , last updated $dateUtils.getDateString($item.getUpdated()) ago
            #end
            . Revision $item.getRevision()
        </td>
    </tr>

    </tbody>

</table>